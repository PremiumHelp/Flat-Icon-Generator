function setupPlaceholder(){previewContext.fillStyle="rgb(200, 200, 200)",previewContext.fillRect(0,0,previewCanvas.width,previewCanvas.height),previewContext.fillStyle="rgb(150, 150, 150)",previewContext.font="16px Helvetica",previewContext.fillText("PREVIEW",120,150)}function generateFlatIconFromImage(e){loadToCanvas(e,function(e){lastCroppedIconCanvas=cropVisibleImageToNewCanvas(e);var a=lastCroppedIconCanvas.width*padding+lastCroppedIconCanvas.width,n=lastCroppedIconCanvas.height*padding+lastCroppedIconCanvas.height;lastIconBackground=createIconBackground(diameterForDimensions(a,n)),lastPaddedIconCanvas=centerCanvas(lastCroppedIconCanvas,lastIconBackground.width,lastIconBackground.height),lastUnmergedIconCanvas=drawShadow(lastPaddedIconCanvas,shadowAngle),lastMergedIconCanvas=mergeIconWithBackground(lastUnmergedIconCanvas,lastIconBackground),updatePreview(),downloadDisabled&&(downloadButton.classList.remove("disabled"),downloadDisabled=!1)})}function updateCurrentPadding(){if(padding=paddingPicker.value,null!=lastCroppedIconCanvas){var e=lastCroppedIconCanvas.width*padding+lastCroppedIconCanvas.width,a=lastCroppedIconCanvas.height*padding+lastCroppedIconCanvas.height;lastIconBackground=createIconBackground(diameterForDimensions(e,a)),lastPaddedIconCanvas=centerCanvas(lastCroppedIconCanvas,lastIconBackground.width,lastIconBackground.height),lastUnmergedIconCanvas=drawShadow(lastPaddedIconCanvas,anglePicker.value),lastMergedIconCanvas=mergeIconWithBackground(lastUnmergedIconCanvas,lastIconBackground),updatePreview()}}function updateCurrentShadow(){shadowAngle=anglePicker.value,shadowOpacity=opacityPicker.value,shadowLength=lengthPicker.value,null!=lastPaddedIconCanvas&&(lastUnmergedIconCanvas=drawShadow(lastPaddedIconCanvas,shadowAngle),lastMergedIconCanvas=mergeIconWithBackground(lastUnmergedIconCanvas,lastIconBackground),updatePreview())}function updateCurrentBackground(){null!=lastUnmergedIconCanvas&&(lastIconBackground=createIconBackground(lastUnmergedIconCanvas.width),lastMergedIconCanvas=mergeIconWithBackground(lastUnmergedIconCanvas,lastIconBackground),updatePreview())}function updatePreview(){previewContext.scale(1/lastScaleFactor,1/lastScaleFactor),previewContext.clearRect(0,0,previewCanvas.width,previewCanvas.height),lastScaleFactor=previewCanvas.width/lastMergedIconCanvas.width,previewContext.scale(lastScaleFactor,lastScaleFactor),previewContext.drawImage(lastMergedIconCanvas,0,0)}function downloadIcon(e){downloadDisabled||(e.href=lastMergedIconCanvas.toDataURL(),e.download="icon.png")}function loadToCanvas(e,a){var n=new Image;n.onload=function(){a(n)},n.src=e}function cropVisibleImageToNewCanvas(e){var a=document.createElement("canvas"),n=a.getContext("2d");a.width=e.width,a.height=e.height,n.drawImage(e,0,0);for(var t=e.width,o=e.height,d=a.getContext("2d").getImageData(0,0,t,o),r=d.data,c=t,l=o,i=0,s=0,g=0;o>g;g++)for(var u=0;t>u;u++){var v=r[4*(t*g+u)+3];v>0&&(c>u&&(c=u),u>i&&(i=u),l>g&&(l=g),g>s&&(s=g))}var h=i-c+1,p=s-l+1,C=document.createElement("canvas");return C.width=h,C.height=p,C.getContext("2d").drawImage(e,c,l,h,p,0,0,h,p),C}function createIconBackground(e){var a=document.createElement("canvas");a.width=e,a.height=e;var n=a.getContext("2d");return n.fillStyle=defaultIconColor,"circle"==shapePicker.value?(n.arc(e/2,e/2,e/2,0,2*Math.PI),n.fill()):n.fillRect(0,0,e,e),a}function centerCanvas(e,a,n){var t=document.createElement("canvas");t.width=a,t.height=n;var o=.5*(a-e.width),d=.5*(n-e.height);return t.getContext("2d").drawImage(e,o,d),t}function drawShadow(e,a){var n=e.width,t=e.getContext("2d"),o=.0174532925,d=Math.tan(a*o),r=document.createElement("canvas"),c=r.getContext("2d");r.width=n,r.height=n,c.drawImage(e,0,0),c.imageSmoothingEnabled=!0;for(var l=1;n/2*shadowLength>l;l++){c.drawImage(e,l,d*l);var i=(l-1)*d;if(d*l>1)for(;l*d>i&&n>i;)c.drawImage(e,l,i),i++}for(var s=c.getImageData(0,0,n,n),g=s.data,u=t.getImageData(0,0,n,n),v=u.data,l=0,h=g.length;h>l;l+=4){var p=g[l+3]/255,C=v[l+3]/255;p>0&&(C>0?(g[l]=v[l]+0*(1-shadowOpacity),g[l+1]=v[l+1]+0*(1-shadowOpacity),g[l+2]=v[l+2]+0*(1-shadowOpacity),g[l+3]=v[l+3]+(1-shadowOpacity)*g[l+3]):(g[l]=0,g[l+1]=0,g[l+2]=0,g[l+3]=g[l+3]*shadowOpacity))}return c.putImageData(s,0,0),r}function mergeIconWithBackground(e,a){for(var n=e.width,t=e.getContext("2d"),o=t.getImageData(0,0,n,n),d=o.data,r=a.getContext("2d"),c=r.getImageData(0,0,n,n),l=c.data,i=0,s=l.length;s>i;i+=4){var g=d[i+3]/255,u=l[i+3]/255;u>0&&g>0&&(1==g&&1==u?(l[i]=d[i],l[i+1]=d[i+1],l[i+2]=d[i+2],l[i+3]=d[i+3]):(l[i]=d[i]+(1-g)*l[i],l[i+1]=d[i+1]+(1-g)*l[i+1],l[i+2]=d[i+2]+(1-g)*l[i+2],l[i+3]=d[i+3]+(1-g)*l[i+3]))}var v=document.createElement("canvas");return v.width=n,v.height=n,v.getContext("2d").putImageData(c,0,0),v}function diameterForDimensions(e,a){return Math.sqrt(e*e+a*a)}function handleFileSelect(e){handleDragExit(),e.stopPropagation(),e.preventDefault();for(var a,n=e.dataTransfer?e.dataTransfer.files:e.target.files,t=0;a=n[t];t++)if(a.type.match("image.*")){var o=new FileReader;o.onload=function(e){return function(e){generateFlatIconFromImage(e.target.result)}}(a),o.readAsDataURL(a)}}function handleDragOver(e){handleDragEnter(),e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}function handleDragEnter(){document.getElementById("drop_zone").classList.add("dropping")}function handleDragExit(){document.getElementById("drop_zone").classList.remove("dropping")}function triggerFileUpload(){document.getElementById("files").click()}function setupFileListener(){var e=document.getElementById("drop_zone");e.addEventListener("dragexit",handleDragExit,!1),e.addEventListener("dragleave",handleDragExit,!1),e.addEventListener("drop",handleFileSelect,!1),e.addEventListener("dragenter",handleDragEnter,!1),e.addEventListener("dragover",handleDragOver,!1),document.getElementById("files").addEventListener("change",handleFileSelect,!1)}var previewCanvas=document.getElementById("canvas"),previewContext=canvas.getContext("2d"),downloadButton=document.getElementById("download"),colorPicker=document.getElementById("colorPicker"),shapePicker=document.getElementById("shapePicker"),paddingPicker=document.getElementById("paddingPicker"),anglePicker=document.getElementById("anglePicker"),opacityPicker=document.getElementById("opacityPicker"),lengthPicker=document.getElementById("lengthPicker"),defaultIconColor="hsl(168, 76%, 42%)",downloadDisabled=!0,shadowOpacity=.3,shadowLength=1,shadowAngle=45,padding=0,lastCroppedIconCanvas,lastIconBackground,lastPaddedIconCanvas,lastUnmergedIconCanvas,lastMergedIconCanvas,lastScaleFactor;$(colorPicker).colpick({color:defaultIconColor,layout:"hex",submit:0,colorScheme:"dark",onChange:function(e,a,n,t,o){$(t).css("border-color","#"+a),defaultIconColor="#"+a,updateCurrentBackground(),o||$(t).val(a)}}).keyup(function(){$(this).colpickSetColor(this.value)}),$(opacityPicker).rangeslider({polyfill:!1,onSlide:function(e,a){updateCurrentShadow()}}),$(lengthPicker).rangeslider({polyfill:!1,onSlide:function(e,a){updateCurrentShadow()}}),$(anglePicker).rangeslider({polyfill:!1,onSlide:function(e,a){updateCurrentShadow()}}),$(paddingPicker).rangeslider({polyfill:!1,onSlide:function(e,a){updateCurrentPadding()}}),shapePicker.onchange=function(){updateCurrentBackground()},setupPlaceholder(),setupFileListener();